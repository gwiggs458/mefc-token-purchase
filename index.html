<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy MEFC Tokens - Meme Fight Club</title>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            background: #000; 
            font-family: sans-serif;
        }
        .mefc-sale-widget {
            background: #222;
            color: #fff;
            padding: 2rem;
            max-width: 400px;
            margin: auto;
            border-radius: 12px;
            text-align: center;
            font-family: sans-serif;
        }
        .mefc-sale-widget input, .mefc-sale-widget button {
            width: 100%;
            margin: 0.5rem 0;
            padding: 0.6rem;
            border-radius: 6px;
            box-sizing: border-box;
        }
        .mefc-sale-widget button {
            background: #0f0;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }
        .mefc-sale-widget button:disabled {
            background: #666;
            color: #ccc;
            cursor: not-allowed;
        }
        .mefc-sale-widget input {
            background: #333;
            color: #fff;
            border: 1px solid #555;
        }
        .mefc-sale-widget a {
            color: #0f0;
            text-decoration: underline;
        }
        .mefc-calculation {
            background: #333;
            border: 1px solid #0f0;
            border-radius: 6px;
            padding: 0.6rem;
            margin: 0.5rem 0;
            font-weight: bold;
            color: #0f0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="mefc-sale-widget">
        <h2>Buy $MEFC</h2>
        <p>1 SUI = 6,000 MEFC</p>
        <button id="connectWallet">Connect Wallet</button>
        <input id="suiAmount" type="number" placeholder="Enter SUI amount" />
        <div id="mefcCalculation" class="mefc-calculation">You will receive: 0 MEFC</div>
        <button id="buyBtn">Buy Now</button>
        <p id="mefcResult"></p>
        <small>
            Token:
            <a href="https://suivision.xyz/coin/0xc44a14f76b8defe396f91b34dbeb8904928bce4084f52eb49cd3b2ca489c4ae6::mefc::MEFC" 
               target="_blank">
                MEFC on SuiVision
            </a>
        </small>
    </div>

    <script type="module">
        // Import Sui libraries
        const { SuiClient, getFullnodeUrl, TransactionBlock } = await import("https://unpkg.com/@mysten/sui.js/dist/esm/index.js");

        const client = new SuiClient({ url: getFullnodeUrl("mainnet") });
        const MIST = 1_000_000_000;
        const RECEIVER = "0x2f68e30da13bf7a9261d8c2ee55cffdf70d072732ae336f37ea411c0c2f653e9";
        let wallet = null;
        let account = null;

        // MEFC calculation function
        function updateMEFCCalculation() {
            const suiAmount = parseFloat(document.getElementById("suiAmount").value) || 0;
            const mefcAmount = suiAmount * 6000;
            const calcDiv = document.getElementById("mefcCalculation");
            
            if (suiAmount > 0) {
                calcDiv.innerText = `You will receive: ${mefcAmount.toLocaleString()} MEFC`;
                calcDiv.style.display = 'block';
            } else {
                calcDiv.style.display = 'none';
            }
        }

        // Check for available wallets
        function getAvailableWallet() {
            if (window.suiWallet) return window.suiWallet;
            if (window.suiet) return window.suiet;
            if (window.martianWallet) return window.martianWallet;
            return null;
        }

        // Connect wallet function
        async function connectWallet() {
            const resultField = document.getElementById("mefcResult");
            const availableWallet = getAvailableWallet();
            
            if (!availableWallet) {
                resultField.innerText = "Please install a Sui wallet extension (Sui Wallet, Suiet, or Martian)";
                return;
            }

            try {
                resultField.innerText = "Connecting to wallet...";
                await availableWallet.connect();
                const accounts = await availableWallet.getAccounts();
                wallet = availableWallet;
                account = accounts[0];
                
                document.getElementById("connectWallet").innerText = "Connected: " + account.slice(0, 6) + "...";
                resultField.innerText = "Wallet connected! You can now make purchases.";
            } catch (err) {
                console.error("Wallet connect error:", err);
                resultField.innerText = "Connection failed: " + err.message;
            }
        }

        // Buy MEFC function
        async function buyMEFC() {
            const suiAmount = parseFloat(document.getElementById("suiAmount").value);
            const resultField = document.getElementById("mefcResult");

            if (!suiAmount || suiAmount <= 0) {
                resultField.innerText = "Please enter a valid SUI amount.";
                return;
            }

            if (!wallet || !account) {
                resultField.innerText = "Please connect your wallet first.";
                return;
            }

            try {
                resultField.innerText = "Processing transaction...";
                
                const tx = new TransactionBlock();
                const amountInMist = Math.floor(suiAmount * MIST);
                tx.transferObjects(
                    [tx.splitCoins(tx.gas, [tx.pure(amountInMist)])],
                    tx.pure(RECEIVER)
                );

                const result = await wallet.signAndExecuteTransactionBlock({
                    transactionBlock: tx,
                    options: { showEffects: true }
                });

                if (result?.effects?.status?.status === "success") {
                    const mefcAmount = suiAmount * 6000;
                    resultField.innerText = `Success! You will receive ${mefcAmount.toLocaleString()} MEFC tokens within 1 hour.`;
                    
                    document.getElementById("suiAmount").value = '';
                    updateMEFCCalculation();
                } else {
                    resultField.innerText = "Transaction failed.";
                }
            } catch (err) {
                console.error("TX error:", err);
                resultField.innerText = "Transaction error: " + err.message;
            }
        }

        // Event listeners
        document.getElementById("connectWallet").addEventListener("click", connectWallet);
        document.getElementById("suiAmount").addEventListener("input", updateMEFCCalculation);
        document.getElementById("buyBtn").addEventListener("click", buyMEFC);
    </script>
</body>
</html>
